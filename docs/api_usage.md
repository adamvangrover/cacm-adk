# CACM-ADK API Usage Guide

This guide provides detailed instructions for interacting with the CACM Authoring & Development Kit (ADK) REST API.

## Base URL

When running the API server locally (e.g., via Uvicorn directly or through Docker), the base URL for all endpoints is:

`http://localhost:8000`

## Interactive API Documentation

The API includes interactive documentation generated by FastAPI:

*   **Swagger UI:** `http://localhost:8000/docs`
*   **ReDoc:** `http://localhost:8000/redoc`

These interfaces allow you to explore endpoints, view schemas, and test API calls directly in your browser.

## API Endpoints

### `GET /templates/`

Lists available CACM templates.

**Request:**

No request body.

**Response Body:**

Returns a JSON array of available templates, including their filename, name, and description.

*Example Response (`application/json`):*
```json
[
  {
    "filename": "basic_ratio_analysis_template.json",
    "name": "Basic Ratio Analysis",
    "description": "As a starting point for common ratio calculations. Customize input/output schemas and specific ratios as needed."
  },
  {
    "filename": "sme_scoring_model_template.json",
    "name": "SME Scoring Model (Simplified)",
    "description": "As a starting point for building SME credit scoring capabilities. Customize inputs, outputs, scoring logic, and parameters."
  }
  // ... more templates
]
```
*(Note: The actual list and content depend on the template files present in `cacm_library/templates/` and their successful parsing by the `TemplateEngine`.)*

**Example `curl` command:**
```bash
curl -X GET "http://localhost:8000/templates/"
```

---

### `POST /templates/{template_filename}/instantiate`

Instantiates a specified CACM template.

**Path Parameters:**

*   `template_filename` (string, required): The filename of the template to instantiate (e.g., `sme_scoring_model_template.json`).

**Request Body (Optional):**

JSON payload to override fields in the instantiated template. See `TemplateOverride` Pydantic model in `api/main.py`.

*Example Payload (`application/json`):*
```json
{
  "name": "My Custom SME Score Model",
  "description": "A specific instance for evaluating preferred clients.",
  "cacm_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "metadata_overrides": {
    "author": "Analyst Team A",
    "tags": ["custom_sme", "preferred_client"]
  }
}
```

**Response Body:**

Returns the fully instantiated CACM JSON object.

*Example `curl` command:*
```bash
curl -X POST "http://localhost:8000/templates/sme_scoring_model_template.json/instantiate" \
     -H "Content-Type: application/json" \
     -d '{
           "name": "Instantiated SME Model via Curl",
           "metadata_overrides": { "author": "Curl Test User" }
         }'
```
*(Note: Template instantiation now expects pure JSON files.)*

---

### `POST /cacm/validate/`

Validates a given CACM instance (JSON payload) against the official CACM JSON schema.

**Request Body:**

Requires a JSON payload containing the full CACM instance data. See `CacmInstance` Pydantic model in `api/main.py`.

*Example Payload (`application/json`):*
```json
{
  "cacm_data": {
    "cacmId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "version": "1.0.0",
    "name": "SME Credit Score - Example AlphaCorp",
    "description": "An example CACM instance for scoring AlphaCorp.",
    "metadata": {"creationDate": "2023-10-28T14:30:00Z"},
    "inputs": {
      "smeFinancials": {
        "description": "Financial statements for AlphaCorp.",
        "type": "object",
        "value": {
           "balanceSheet": { "totalAssets": 500000, "totalLiabilities": 200000 }
        }
      }
    },
    "outputs": {
      "creditScore": {
        "description": "The calculated credit score.",
        "type": "number"
      }
    },
    "workflow": [
      {
        "stepId": "s1_calc_score",
        "description": "Calculate score",
        "computeCapabilityRef": "model:FinancialMetricsScorer_v1",
        "inputBindings": { "financial_data": "cacm.inputs.smeFinancials.value"},
        "outputBindings": {"score_output": "cacm.outputs.creditScore"}
      }
    ]
  }
}
```

**Response Body:**

Returns a JSON object indicating if the CACM is valid, along with any validation errors. See `ValidationResponse` Pydantic model.

*Example Response (Invalid):*
```json
{
  "is_valid": false,
  "errors": [
    {
      "path": ["inputs", "smeFinancials"],
      "message": "'type' is a required property",
      "validator": "required"
    }
  ],
  "message": "CACM instance is invalid."
}
```

*Example `curl` command:*
```bash
curl -X POST "http://localhost:8000/cacm/validate/" \
     -H "Content-Type: application/json" \
     -d @examples/sme_credit_score_example_01.json 
```
*(Note: Replace `@examples/sme_credit_score_example_01.json` with the actual path to a CACM JSON file if using `curl` this way, or embed the JSON directly.)*

---

### `POST /cacm/run/`

Simulates the execution of a CACM instance's workflow.

**Request Body:**

Requires a JSON payload containing the full CACM instance data. Same as `/cacm/validate/`.

*Example Payload (`application/json`):*
Use a valid CACM JSON, like `examples/sme_credit_score_example_01.json`.

**Response Body:**

Returns a JSON object indicating the success of the execution. Includes detailed `log_messages` from the orchestrator, and the final `outputs` of the CACM (which may be a mix of actual results from executed functions and mocked values).

*Example Response (`application/json`):*
```json
{
  "success": true,
  "message": "CACM workflow execution (simulated/actual) completed successfully.",
  "log_messages": [
    "INFO: Orchestrator: CACM instance is valid. Starting execution...",
    "INFO: Orchestrator: --- Executing Step 's1_calc_ratio': Calculate Debt to Equity ---",
    "INFO: Orchestrator:   Compute Capability: cc:CalculateRatio_v1",
    "INFO: Orchestrator: Attempting to execute real function for cc:CalculateRatio_v1",
    "INFO: Orchestrator:   Input Bindings: {'numerator': 'cacm.inputs.inputNumerator.value', 'denominator': 'cacm.inputs.inputDenominator.value'}",
    "INFO: Orchestrator:   Executed cc:CalculateRatio_v1, result: 2.0",
    "INFO: Orchestrator:   Output Bindings: {'result': 'cacm.outputs.debtToEquity'}",
    "INFO: Orchestrator: Mapped step output 'result' to CACM output 'debtToEquity'.",
    "INFO: Orchestrator: --- Executing Step 's2_score_d_e': Score Debt to Equity ---",
    "INFO: Orchestrator:   Compute Capability: cc:SimpleScorer_v1",
    "INFO: Orchestrator: Attempting to execute real function for cc:SimpleScorer_v1",
    "INFO: Orchestrator:   Input Bindings: {'financial_metric': 'steps.s1_calc_ratio.outputs.result', 'threshold': 2.5, 'operator': '<'}",
    "INFO: Orchestrator:   Executed cc:SimpleScorer_v1, result: \"Below Threshold\"",
    "INFO: Orchestrator:   Output Bindings: {'assessment': 'cacm.outputs.equityRiskAssessment'}",
    "INFO: Orchestrator: Mapped step output 'assessment' to CACM output 'equityRiskAssessment'.",
    "INFO: Orchestrator: Execution completed."
  ],
  "outputs": {
    "debtToEquity": {
      "value": 2.0,
      "description": "Output from cc:CalculateRatio_v1 via step s1_calc_ratio"
    },
    "equityRiskAssessment": {
      "value": "Below Threshold",
      "description": "Output from cc:SimpleScorer_v1 via step s2_score_d_e"
    }
  }
}
```

*Example `curl` command:*
```bash
curl -X POST "http://localhost:8000/cacm/run/" \
     -H "Content-Type: application/json" \
     -d @examples/sme_credit_score_example_01.json
```

---

### `POST /reports/generate/sme_credit_score/`

Generates an enhanced, simulated SME credit score report.

**Request Body:**

Requires JSON payload with SME financial and qualitative data. See `SmeInputData` Pydantic model in `api/main.py` for exact structure.

*Example Payload (`application/json`):*
```json
{
  "smeFinancialsValue": {
    "companyId": "SME_API_Doc_001",
    "balanceSheet": { "totalAssets": 750000, "totalLiabilities": 300000 },
    "incomeStatement": { "revenue": 1800000, "netIncome": 220000 }
  },
  "qualitativeDataValue": {
    "managementExperienceYears": 15,
    "industryOutlook": "positive"
  },
  "parameters_override": [
    {"paramId": "scoreWeightFinancial", "value": 0.65}
  ]
}
```

**Response Body:**

Returns a highly detailed JSON report. The `detailedRationale` field now contains synthesized insights from multiple simulated analytical perspectives (fundamental, regulatory, market, strategic). The `keyRiskFactors_XAI` is also more comprehensive. See `ReportResponse` Pydantic model in `api/main.py` and the `ReportGenerator` class for the full structure, including S&P/SNC rating mappings.

*Example `curl` command:*
```bash
curl -X POST "http://localhost:8000/reports/generate/sme_credit_score/" \
     -H "Content-Type: application/json" \
     -d '{
           "smeFinancialsValue": {
             "companyId": "SME_Curl_Test_001",
             "balanceSheet": { "totalAssets": 600000, "totalLiabilities": 250000 },
             "incomeStatement": { "revenue": 1500000, "netIncome": 180000 }
           },
           "qualitativeDataValue": {
             "managementExperienceYears": 12,
             "industryOutlook": "stable"
           }
         }'
```

This provides a comprehensive guide for interacting with the CACM-ADK API.

---

## Ontology Endpoints

These endpoints allow for programmatic exploration of the project's credit analysis ontology.

### `GET /ontology/classes/`
Lists all defined classes in the ontology.
*   **Response Body:** A JSON array of objects, each with `uri`, `prefixed_name`, and `label`.
*   *Example `curl` command:*
    ```bash
    curl -X GET "http://localhost:8000/ontology/classes/"
    ```

### `GET /ontology/properties/`
Lists all defined properties in the ontology.
*   **Response Body:** A JSON array of objects, each with `uri`, `prefixed_name`, and `label`.
*   *Example `curl` command:*
    ```bash
    curl -X GET "http://localhost:8000/ontology/properties/"
    ```

### `GET /ontology/terms/{namespace_prefix}/{term_name}`
Retrieves detailed information for a specific ontology term.
*   **Path Parameters:**
    *   `namespace_prefix`: The short prefix for the namespace (e.g., `kgclass`, `cacm_ont`).
    *   `term_name`: The local name of the term (e.g., `LeverageRatio`).
*   **Response Body:** A JSON object with details like `uri`, `prefixed_name`, `label`, `comment`, `rdf_types`, `type_category`, and context-specific fields like `superclasses` (for classes) or `domains`/`ranges` (for properties).
*   *Example `curl` command:*
    ```bash
    curl -X GET "http://localhost:8000/ontology/terms/kgclass/LeverageRatio"
    ```
